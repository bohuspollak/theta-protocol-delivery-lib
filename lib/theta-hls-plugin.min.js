!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThetaHlsJsFragmentLoader=t():e.ThetaHlsJsFragmentLoader=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";function n(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,o){try{var i=t[a](o),l=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(l).then(function(e){n("next",e)},function(e){n("throw",e)});e(l)}return n("next")})}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=function e(t,r,n){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,r);if(void 0===a){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in a)return a.value;var i=a.get;if(void 0!==i)return i.call(n)},s=r(2),f=function(e){return e&&e.__esModule?e:{default:e}}(s),c=function(e){function t(){return a(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return i(t,e),l(t,[{key:"rangeCheck",value:function(e){var t=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){f.default.log("Sending HEAD request to url "+e.url),t.segmentEtag=null,t.contentLength=null}}).done(function(e,r,n){t.contentLength=n.getResponseHeader("Content-Length"),t.segmentEtag=n.getResponseHeader("etag"),f.default.log("HEAD request successful, etag="+t.segmentEtag)})}},{key:"integrityCheck",value:function(e){if(f.default.log("integrityCheck etag="+this.segmentEtag),this.segmentEtag){var t=md5(e),r='"'===this.segmentEtag[0]?this.segmentEtag.substring(1,this.segmentEtag.length-1):this.segmentEtag;return f.default.log("verifying md5 checksum of the segment md5sum="+t),t===r}return!0}},{key:"load",value:function(e,t,r){var n=this;if(f.default.info("URL "+e.url+" Range end "+e.rangeEnd),f.default.info("ctx: ",e),this.thetaCtx.cache.has(e.url+e.rangeEnd))f.default.info("load from cache - ",e.url),this.loadFromCache(e,t,r);else if(null===this.thetaCtx.p2p.id)f.default.info("not connected to peerjs, load from CDN..."),this.loadFromCDN_old(e,t,r);else if(this.thetaCtx.p2p.useCDN)f.default.info("configuration has useCDN enabled, load from CDN..."),this.loadFromCDN_old(e,t,r);else{var a=this.thetaCtx.p2p,o=this.thetaCtx.playerStats,i=this;if(0===Object.keys(a.peers).length){f.default.info("no peer yet for "+a.id+", load from UCN");Math.floor(Date.now());this.tryLoadFromUCN(e,t,r)}else{var l=Math.floor(Date.now()),u=this.thetaCtx.p2p.probeTimeout,s=i._getNewUrl(e.url);f.default.info("New URL before probe is: ",s,e.rangeEnd),a.probeFromPeerWithTimeout(s+e.rangeEnd,u).then(function(u){f.default.info("SPLIT DEBUG - response after probe:",u);var c=Math.floor(Date.now());f.default.info("probeFromPeerWithTimeout - fragment "+(s+e.rangeEnd)+" found from peer "+u.peerid);var d=u.peerid;o.processFragmentReq(d,"probe_req_overview_replied"),o.processProbeReq(d,c-l);var g=Math.floor(1e3*e.frag.duration*.8),h=new Array(6);a.loadFromSpecificPeerWithTimeout(s+e.rangeEnd,d,g,5,h).then(function(i){"kOK"===i.result?(f.default.log("SPLIT DEBUG - kOk res of loadFromSpecificPeerWithTimeout:",i),f.default.log("SPLIT DEBUG - data in kOk:",h),f.default.log("SPLIT DEBUG - ctx in kOK:",e),n.loadFromPeer(e,i,d,o,c,a,r,h,t)):(f.default.warn("remote peer "+d+" reject getFragment req, try CDN"),f.default.log("SPLIT DEBUG - data in kOk else:",h),o.processFragmentReq(d,"fragment_req_rejected"),n.tryLoadFromUCN(e,t,r))}).catch(function(l){f.default.warn("loadFromSpecificPeer gets timeout, "+e.url+" try CDN  - "+d);var u=h.slice(0);if(u.invoice=h.invoice,f.default.log("SPLIT DEBUG - newData catch:",u),l.message?f.default.error("error message -",l.message):f.default.error("error without msg -",l),u[0]&&u[u.length-1]){var s=u.reduce(function(e,t){return i._appendBuffer(e,t)},new ArrayBuffer);if(s.byteLength===u[u.length-1]){f.default.log("SPLIT DEBUG - [corner case] In corner case!");var p={data:s,invoice:u.invoice,totalLength:s.byteLength,type:"fragment",url:e.url};f.default.log("SPLIT DEBUG - [corner case] res:",p),f.default.log("SPLIT DEBUG - [corner case] ctx:",e),f.default.log("SPLIT DEBUG - [corner case] peerid:",d),n.loadFromPeer(e,p,d,o,c,a,r)}else o.processFragmentReq(d,"fragment_req_timeout"),n.loadPartFromPeer(e.url,u,s.byteLength,d,g,o,a),e.rangeStart=s.byteLength,e.rangeEnd=u[u.length-1],f.default.log("SPLIT DEBUG - ctx in load from cdn:",e),f.default.log("SPLIT DEBUG - newData in load from cdn:",u),f.default.log("SPLIT DEBUG - tmp in load from cdn:",s),n.loadFromCDN(e,t,r,u)}else o.processFragmentReq(d,"fragment_req_timeout"),f.default.log("SPLIT DEBUG - load from cdn use the old function."),n.tryLoadFromUCN(e,t,r)})}).catch(function(a){f.default.warn("probeFromPeerWithTimeout ends, "+u+" timeout"),f.default.warn("probeFromPeerWithTimeout ends with err: ",a);var o=n.thetaCtx.playerStats;"timeout"===a.type?o.processFragmentReq(null,"probe_req_overview_timeout"):o.processFragmentReq(null,"probe_req_overview_notCached"),n.tryLoadFromUCN(e,t,r)})}}}},{key:"loadFromCache",value:function(e,t,r){f.default.info("Serving from cache: ",e.origin_url);var n=this.thetaCtx.cache,a=n.get(e.origin_url),o=null,i=null;null!==a&&void 0!==a&&(o=a[0].data.slice(0),i=a[1]);var l={data:o,url:e.origin_url};r.onSuccess(l,i,e)}},{key:"tryLoadFromUCN",value:function(e,t,r){var n=this;if(f.default.info("Loading url: ",e.url),this.thetaCtx.p2p.useUCN){var a=this.thetaCtx.p2p.ucn,o="https://"+a.host+":8080/live/"+this.thetaCtx.p2p.videoId+"/ucnmap.json";e.originalUrl=e.url,e.url=this._getNewUrl(e.url),this.getUcnMap(o,e.url).then(function(o){var i=o;e.ucnMap=Object.assign({},i),e.cdnUrl=e.url,e.url="https://"+a.host+":8080/live/"+i[e.cdnUrl],n.loadFromUCN(e,t,r)}).catch(function(a){f.default.info("getUcnMap returns an error: ",a),f.default.info("getUcnMap didn't have the key, load from CDN"),e.url=e.originalUrl,n.loadFromCDN_old(e,t,r)})}else f.default.info("useUCN is false, load from CDN"),this.loadFromCDN_old(e,t,r)}},{key:"getUcnMap",value:function(e,t){return new Promise(function(r,a){var o=this;$.ajax({type:"get",async:!0,url:e,crossdomain:!0}).done(function(){var e=n(regeneratorRuntime.mark(function e(n,i,l){var u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:u=JSON.parse(n),f.default.debug("UCN map is: ",u),u.hasOwnProperty(t)?r(u):(f.default.info("UCN map doesn't have "+t+" as a key"),a("Error - no matched key"));case 3:case"end":return e.stop()}},e,o)}));return function(t,r,n){return e.apply(this,arguments)}}())})}},{key:"loadPartFromPeer",value:function(e,t,r,n,a,o,i){f.default.log("SPLIT DEBUG - IN load part from peer"),f.default.log("SPLIT DEBUG - data",t),f.default.log("SPLIT DEBUG - url",e),f.default.log("SPLIT DEBUG - peerid",n);var l=null;t.invoice&&(l=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:r},peer:{id:n,address:l}}),o.processFragment(e,"fromPeer",r,a),o.processFragmentReq(n,"fragment_req_replied");var u=i.peers[n];try{t.invoice?i.shouldSendPayment(t,n)?(f.default.log("SPLIT DEBUG - Sending payment to "+t.invoice.address),i.sendPayment(t.invoice,u)):f.default.log("SPLIT DEBUG - Should not send payment. Skipping payment."):f.default.log("SPLIT DEBUG - No invoice is included in peer response. Skipping payment.")}catch(e){f.default.error("Error sending payment: ",e)}}},{key:"loadFromPeer",value:function(e,t,r,n,a,o,i){f.default.info("fragment "+t.url+" received from peer "+r);var l={url:t.url,data:t.data},u={size:t.data.byteLength,loaded:t.data.byteLength,trequest:performance.now()},s=Math.floor(Date.now()),c=null;if(f.default.info("getFragment from peer, takes "+(s-a)+" ms"),!this.integrityCheck(l.data.slice(0)))return void f.default.error("segment integrity check (from peer) fails, skip loading");t.invoice&&(c=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:l.data.byteLength},peer:{id:r,address:c}});var d=this._getNewUrl(e.url);f.default.info("Key in the cache from peers:",d+e.rangeEnd),this.thetaCtx.cache.set(d+e.rangeEnd,[{data:t.data.slice(0),url:t.url},u,e]),n.processFragment(e.url,"fromPeer",t.data.byteLength,s-a),n.processFragmentReq(r,"fragment_req_replied");var g=o.peers[r];try{t.invoice?(f.default.debug("Sending payment to "+t.invoice.address),o.sendPayment(t.invoice,g)):f.default.debug("No invoice is included in peer response. Skipping payment.")}catch(e){f.default.error("Error sending payment: ",e)}i.onSuccess(l,u,e)}},{key:"loadFromCDN",value:function(e,t,r,n){var a=Math.floor(Date.now()),o=this,i=new XMLHttpRequest;try{i.open("GET",e.url,!0)}catch(t){return void r.onError({code:i.status,text:t.message},e,i)}e.rangeEnd&&i.setRequestHeader("Range","bytes="+e.rangeStart+"-"+e.rangeEnd),i.responseType=e.responseType,i.callbacks=r;var l=this.thetaCtx.playerStats;i.onload=function(t){f.default.info(i.response);var u=i.response;if(u){var s=Object.assign({},r),c=s.onSuccess,d=o.thetaCtx.cache,g={size:u.byteLength,loaded:u.byteLength,trequest:performance.now()};i.callbacks.onSuccess=function(t,r,i){f.default.info("On Success ctx: ",i);var u=Math.floor(Date.now()),s=u-a;if(f.default.info("getFragment from CDN, "+t.data.byteLength+" bytes takes "+s+" ms"),l.processFragment(i.url+"undefined","fromCDN",t.data.byteLength,u-a),!o.integrityCheck(t.data.slice(0)))return void f.default.error("segment integrity check (from CDN) fails, skip loading");var g=o._getNewUrl(i.url);f.default.info("New URL before set cache is: ",g),d.set(g+"undefined",[{data:t.data.slice(0),url:t.url},r,i]),o.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:t.data.byteLength},peer:null});var h=n[n.length-1];n[n.length-1]=t.data,f.default.log("SPLIT DEBUG - data before newRes:",n);var p={url:t.url,data:n.reduce(function(e,t){return o._appendBuffer(e,t)},new ArrayBuffer)};f.default.log("SPLIT DEBUG - is newRes data length match:",p.data.byteLength===h),f.default.log("SPLIT DEBUG - newRes:",p),c(p,r,e)};var h={url:i.responseURL,data:u};i.onreadystatechange=o.readystatechange.bind(o),i.callbacks.onSuccess(h,g,e)}},i.send()}},{key:"readystatechange",value:function(e){u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"readystatechange",this).call(this,e)}},{key:"_getSequence",value:function(e){for(var t=[],r=0;r<e;r++)t[r]=r;return t=this._shuffle(t)}},{key:"_shuffle",value:function(e){for(var t=e.length,r=void 0,n=void 0;t>0;)n=Math.floor(Math.random()*t),t--,r=e[t],e[t]=e[n],e[n]=r;return e}},{key:"_appendBuffer",value:function(e,t){if(!e||!e.byteLength)return t;if(!t||!t.byteLength)return e;var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}},{key:"_checkData",value:function(e){for(var t=0;t<e.length;t++)if(void 0===e[t])return!1;return!0}},{key:"_changeCJUrl",value:function(e){var t=e.split("/media_");return t[0]+"/media_"+t[1].split("_")[1]}},{key:"_byPassQueryUrl",value:function(e){var t=e;if(e.includes(".ts?")){t=e.split(".ts?")[0]+".ts"}return t}},{key:"_getCDNUrl",value:function(e,t){var r=e.split("/live/")[1];f.default.info("In get CDN url, url is: "+e+". val = "+r);var n="";return n=t?Object.keys(t).find(function(e){return t[e]===r}):"",f.default.log("Get CDN url: ",n),n}},{key:"_getNewUrl",value:function(e){var t=e;return"cjhellothetatestnet"===this.thetaCtx.p2p.videoId?t=this._changeCJUrl(e):this.thetaCtx.p2p.segUrlBypassQuery&&(t=this._byPassQueryUrl(e)),t=this._byPassQueryUrl(t)}},{key:"loadFromUCN",value:function(e,r,n){var a=this;f.default.info("ThetaHlsJsFragmentLoader: loadFromUCN");var o=this,i=this.thetaCtx.cache,l=n.onSuccess,s=Math.floor(Date.now()),c=this.thetaCtx.playerStats;n.onSuccess=function(e,t,r){var n=Math.floor(Date.now()),u=n-s;if(f.default.info("getFragment from UCN, "+e.data.byteLength+" bytes takes "+u+" ms"),c.processFragment(r.url,"fromPeer",e.data.byteLength,n-s),!a.integrityCheck(e.data.slice(0)))return void f.default.error("segment integrity check (from UCN) fails, skip loading");var d=o._getCDNUrl(r.url,r.ucnMap);i.set(d+r.rangeEnd,[{data:e.data.slice(0),url:e.url},t,r]),a.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:e.data.byteLength},peer:null}),l(e,t,r)},u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"load",this).call(this,e,r,n)}},{key:"loadFromCDN_old",value:function(e,r,n){var a=this;f.default.info("ThetaHlsJsFragmentLoader: loadFromCDN"),f.default.info("Loading url: ",e.url,e.rangeEnd);var o=this.thetaCtx.cache,i=n.onSuccess,l=Math.floor(Date.now()),s=this.thetaCtx.playerStats,c=this;n.onSuccess=function(e,t,r){f.default.info("On Success ctx: ",r.rangeEnd,r);var n=Math.floor(Date.now()),u=n-l;if(f.default.info("getFragment from CDN, "+e.data.byteLength+" bytes takes "+u+" ms"),s.processFragment(r.url,"fromCDN",e.data.byteLength,n-l),!a.integrityCheck(e.data.slice(0)))return void f.default.error("segment integrity check (from CDN) fails, skip loading");var d=c._getNewUrl(r.url);f.default.info("New URL before set cache is: ",d,r.rangeEnd),o.set(d+r.rangeEnd,[{data:e.data.slice(0),url:e.url},t,r]),a.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:e.data.byteLength},peer:null}),i(e,t,r)},u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"load",this).call(this,e,r,n)}}],[{key:"setDebug",value:function(e){f.default.setLoggingEnabled(e)}}]),t}(Hls.DefaultConfig.loader);t.default=c,e.exports=t.default},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=!1,i=function(){function e(){n(this,e)}return a(e,null,[{key:"isLoggingEnabled",value:function(){return o}},{key:"setLoggingEnabled",value:function(e){o=e}},{key:"maybeLog",value:function(e){if(this.isLoggingEnabled()){for(var t,r=new Date,n=arguments.length,a=Array(n>1?n-1:0),o=1;o<n;o++)a[o-1]=arguments[o];(t=console).log.apply(t,["["+r.toLocaleString()+"][THETA]["+e+"]"].concat(a))}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["warn"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["debug"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["error"].concat(t))}}]),e}();t.default=i,e.exports=t.default}])});